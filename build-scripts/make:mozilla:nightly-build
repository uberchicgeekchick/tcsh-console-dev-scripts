#!/bin/tcsh -f
setenv	CFLAGS		"-std=gnu99 -O3 -L/lib64 -L/usr/lib64 -L/usr/lib -L/lib -I/usr/include"
setenv	CXXFLAGS	"-std=gnu++0x -O3 -L/lib64 -L/usr/lib64 -L/usr/lib -L/lib -I/usr/include"
setenv	MAKEFLAGS	"-O3"

if( ${?http_proxy}  ) unsetenv http_proxy

set mozilla_top_dir="/programs/Mozilla";
set tarball_backup_dir="/uberChick/Downloads/Mozilla/Nightly-Builds";

if ( ! ${?1} || "${1}" == "" || "${1}" == "--help" ) then
	printf "Usage: %s (firefox|thunderbird)\n\tchecks out the latest source code for the mozilla project, builds it, makes its package(tarball), and back-ups the built tarball using the build day.\n" `basename "${0}"`;
	exit -1;
endif



init:
cd "${mozilla_top_dir}";

if ( ${?GREP_OPTIONS} ) unsetenv GREP_OPTIONS;
unalias grep;
unalias egrep;


configure:
switch ( "${1}" )
case "thunderbird":
	set build_mozilla="thunderbird";
	set mercurial_repo="comm-central";
	set enable_mozilla="--enable-application=mail --enable-calendar --enable-static";
	set prefix="${mozilla_top_dir}/Thunderbird3";
	breaksw;

case "xulrunner":
	set build_mozilla="xulrunner";
	set mercurial_repo="mozilla-central";
	set enable_mozilla="--enable-application=xulrunner --enable-libxul";
	set prefix="${mozilla_top_dir}/XULRunner-1.9.1";
	breaksw;

case "firefox":
	set build_mozilla="firefox";
	set mercurial_repo="mozilla-central";
	set enable_mozilla="--enable-application=browser --enable-libxul";
	set prefix="${mozilla_top_dir}/Firefox3";
	breaksw;

default:
	printf "%s is an unsupport mozilla build target.\n\tSupported build targets are: xulrunner, firefox, or thunderbird.\n" ${1};
	exit -1;
endsw

set topdir="${mozilla_top_dir}/src";
if ( ! -d "${topdir}" ) mkdir -p "${topdir}";
set srcdir="${topdir}/${build_mozilla}-src";

if( -e "${srcdir}/.make.lock" ) then
	printf "Another instance of %s is using the current source.  Please wait a few seconds than try again." "`basename ${0}`";
	exit -2;
endif

set objdir="${topdir}/${build_mozilla}-objdir";

if ( ${?2} && "${2}" == "--make-package" ) goto make_package



checkout:
touch "${srcdir}/.make.lock";
if ( !( -d "${srcdir}" && -d "${srcdir}/.hg" ) ) then
	set hg_reaction="checkout";
	cd "${topdir}";
	if( "${build_mozilla}" == "firefox" && -d "${topdir}/xulrunner-src" ) then
		set second_src="xulrunner";
	else if( "${build_mozilla}" == "xulrunner" && -d "${topdir}/firefox-src" ) then
		set second_src="firefox";
	endif
	if( ${?second_src} ) then
		printf "\n\nSyncing %s with %s to avoid un-needed network traffic.\n" ${build_mozilla} ${second_src};
		cp -R "${topdir}/${second_src}-src" "${srcdir}" &;
		cd "${srcdir}";
		hg pull -u
	else
		printf "Checking out: %s\n" ${mercurial_repo}
		hg clone "http://hg.mozilla.org/${mercurial_repo}" "${srcdir}";
	endif
else
	cd "${srcdir}";
	set hg_reaction="update";
	if ( "${build_mozilla}" == "thunderbird" && -e client.py ) then
		python client.py checkout;
	else
		hg pull -u;
		if( "${build_mozilla}" == "firefox" && -d "${topdir}/xulrunner-src" ) then
			set second_src="xulrunner";
		else if( "${build_mozilla}" == "xulrunner" && -d "${topdir}/firefox-src" ) then
			set second_src="firefox";
		endif
		if( ${?second_src} ) then
			printf "\n\nSyncing %s with %s to avoid un-needed network traffic.  Coping updates will continue in the back ground.\n" ${build_mozilla} ${second_src};
			cp -R "${srcdir}" "${topdir}/${second_src}-src" &;
			sleep 3;
		endif
	endif
endif

if ( ${status} != "0" ) then
	printf "\n\n********************* FATAL ERROR ************************\n\t\t\tmercurial %s failed with error %s\n\n" ${hg_reaction} ${status};
	exit ${status};
endif
unset hg_reaction;
rm "${srcdir}/.make.lock";



make:
touch "${srcdir}/.make.lock";
cd "${srcdir}";
printf "ac_add_options ${enable_mozilla} --enable-installer --enable-default-toolkit=cairo-gtk2 --enable-optimize=-O3 --disable-freetypetest --disable-updater --disable-pedantic --disable-tests --disable-mochitest --disable-shared\nmk_add_options MOZ_OBJDIR=${objdir}\nmk_add_options AUTOCONF=autoconf-2.13\n" >! ".mozconfig"

gmake -f client.mk build &;
rm "${srcdir}/.make.lock";
wait;
if ( ${status} != "0" ) then
	printf "\n\n********************* FATAL ERROR ************************\n\t\t\tmake failed with error %s\n\n" ${status};
	exit ${status};
endif



make_package:
cd "${objdir}";
make package;



backup:
cd "${objdir}";
set today=`date '+%Y-%m-%d'`;
if ( "${build_mozilla}" == "thunderbird" ) cd mozilla;
pwd
foreach tarball ( dist/*.tar.bz2 )
	set backup_tarball="`basename ${tarball} | sed 's/\(.*\)\(\.tar\.bz2\)/\1\.${today}\2/g'`";
	cp ${tarball} "${tarball_backup_dir}/${backup_tarball}";
	if( ${status} != "0" ) then
		printf "\n\n********************* WARNING: BACKUP ************************\n\t\t\ttarball back-up failed; error: %s\n\n" ${status};
		continue;
	endif
	
	rm "${tarball_backup_dir}"/${build_mozilla}-*.tar.bz2;
	cp ${tarball} "${tarball_backup_dir}/${backup_tarball}";
	set tarball="${tarball_backup_dir}/${backup_tarball}";
end



install:
cd "${objdir}";
tar -C "${prefix}" -xjf "${tarball}";
oif( "${build_mozilla}" == "xulrunner" ) exit 0;



install_plugins:
if ( "${build_mozilla}" != "firefox" ) goto prepare_first_run

cd "${prefix}/${build_mozilla}";
rm -r searchplugins plugins;
ln -s ../searchplugins .;
ln -s ../plugins .;
cd ..;



prepare_first_run:
goto stop_build


make_default:
set second_run
goto stop_build


exec_install:
${prefix}/x86_64/${build_mozilla} &


exit


test_exec:
if(!(${second_run})) then
	set mozilla_exec="${prefix}/${build_mozilla}/${build_mozilla}";
else
	set mozilla_exec="${prefix}/x86_64/${build_mozilla}";
endif

if(! -e ${mozilla_exec} ) then
	printf "\n\n********************* FATAL ERROR ************************\n\t\t\tInstallation of %s failed\n\t\t\tBinary is not executable: [%s]\n\n" ${build_mozilla} ${mozilla_exec};
	exit -1;
endif

if(!(${second_run})) then
	rm -rf "${prefix}/x86_64";
	mv "${prefix}/${build_mozilla}" "${prefix}/x86_64";
	goto exec_install
endif

goto make_default



stop_build:
if(${?exec_stopped}) goto test_exec

foreach program ( ( "${build_mozilla}-bin" "${build_mozilla}" ) )
	foreach pid ( `pidof -x "${program}"` )
		set still_running = ( "\n" );
		while ( "${#still_running}" < 10 )
			kill -QUIT "${pid}";
			sleep 2;
			foreach test ( `pidof -x "${program}"` )
				if ( "${pid}" == "${test}" ) set still_running = ( ${still_running} "\n" );
			end
		end
		kill -9 "${pid}"
	end
end

set exec_stopped

if(! ${?second_run} ) then
	set second_run;
	goto test_exec
endif

goto exec_install

