#!/bin/tcsh -f
switch ( "${1}" )
case "":
case "rsync":
case "scp":
case "sshfs":
case "cp":
case "no-sync":
	printf "Usage: %s commit_message [commit_details] [rsync scp sshfs cp no-sync]\n" `basename "${0}"`
	exit
	breaksw
endsw

set sync_method = ""
if ( -e "./.sync.default" ) then
	set sync_method = `cat ./.sync.default`
else
	set sync_method = "no-sync"
endif

while ( ${?3} && "${3}" != "" )
	switch( "${3}" )
	case "rsync":
	case "scp":
	case "sshfs":
	case "cp":
	case "no-sync":
		set sync_method = "${3}"
		breaksw
	case "no-pushing":
		set no_pushing
		breaksw
	default:
		endsw
	endsw
	shift
end

if ( -e ./.no.pushing ) set no_pushing;

git add .
	
# Remove any vim, GTK-PHP-IDE, gedit, or etc 'swp' files
foreach swp ( "`find . -iregex .\*\.swp`" )
	set swp = "`printf '${swp}' | sed 's/^\.\///'`"
	git rm --cached --quiet "${swp}"
end

# Remove any files that are either just for back-up or more usefully when the files are uber-alphas
foreach being_created ( "`find . -iregex .\*creating:.\*`" )
 	set swp = "`printf '${being_created}' | sed 's/^\.\///'`"
	git rm --cached --quiet "${being_created}"
end

git commit -a -m "${1}: ${2}"

if (! ${?no_pushing} ) then
	foreach remote_git ( "`git remote`" )
		git push "${remote_git}"
	end
endif

goto check_sync
exit

init_sync:
set project_name = "`basename '${cwd}'`"
set sshfs_path = "/projects/ssh"
set ssh_user = "dreams"
set ssh_server = "avalon.ocssolutions.com"


run_sync:
switch( "${sync_method}" )
case "rsync":
	rsync -r --verbose ./* "${ssh_user}@${ssh_server}:/home/${ssh_user}/${project_name}"
	exit 0
	breaksw

case "scp":
	scp -rv ./* "${ssh_user}@${ssh_server}:/home/${ssh_user}/${project_name}"
	exit 0
	breaksw

case "sshfs":
	if ( `mount | grep "${sshfs_path}"` == "" ) then
		sshfs "${ssh_user}@${ssh_server}:/home/${ssh_user}" "${sshfs_path}"
	endif
case "cp":
	if ( ! -d "${sshfs_path}/${project_name}" ) then
		printf "I couldn't find your project: '%s' in your sshfs path: '%s'\nEither your project doesn't exist on your sshfs or ssh isn't mounted\n", ${project_name}, ${sshfs_path}
		exit
	endif

	# compare "${sshfs_path}/${project_name}/" against ./
	# and remove remote files that no longer exist locally.
	printf "\n\nFinding all remote files to check for stale files and directories.\nPlease be patient as this may take a few moments.\n"
	set remove_remote_regexp = "`printf "\""${sshfs_path}/${project_name}/"\"" | sed 's/\//\\\//g'`"
	foreach remote_file ( "`find '${sshfs_path}/${project_name}/'`" )
		# escape special characters to keep them from being expanded by the terminal
		# set remote_file = "`printf '${remote_file}' | sed 's/\([\.\*\[\]()]\)/\\\1/g' | sed 's/\('\''\)/\1\\\1\1/g'`"

		set git_test = "`printf "\""${remote_file}"\"" | sed 's/.*\(\/\.git\).*/\1/g'`"
		if ( "${git_test}" == "/.git" ) continue

		set local_file = "`printf "\""${remote_file}"\"" | sed 's/^${remove_remote_regexp}/\.\//'`"

		if ( ! -d "${local_file}" && ! -e "${local_file}" ) then
			printf "Removing stale remote "

			if ( -d "${remote_file}" ) then
				printf "directory & contents"
				rm -r "${remote_file}"
			else if ( -e "${remote_file}" ) then
				printf "file"
				rm "${remote_file}"
			endif
			printf ":\n\t%s\n" "${remote_file}"
		endif
	end

	printf "\n\nI am now copying new and/or modified files.\nTo update this project's remote location.\nThis may also take several moments.\n\n"
	# TODO:
	# make copying use a find search result that skips swp files.
	cp -r --verbose --update --no-dereference ./* "${sshfs_path}/${project_name}"

	# cleaning up swp files that may have been copied to the remote location
	foreach swp ( "`find '${sshfs_path}/${project_name}' -iregex .\*\.swp`" )
		rm --verbose "${swp}"
	end

	breaksw
endsw

exit

check_sync:
switch ( "${sync_method}" )
case "rsync":
case "scp":
case "sshfs":
case "cp":
	goto init_sync
	breaksw
case "no-sync":
	exit
	breaksw
default:
	printf "%s is not a supported sync method.  Valid options are:\n\trsync, scp, sshfs, cp, no-sync" "${sync_method}"
	exit
	breaksw
endsw
