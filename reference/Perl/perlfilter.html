<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>perlfilter - perldoc.perl.org</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Language" content="en-gb" />
  <link href="css.css" rel="stylesheet" rev="stylesheet" type="text/css" media="screen" />
</head>

<script language="JavaScript" type="text/javascript" src="label.js"></script>

<script language="JavaScript">
  pageDepth = 0;
  setPath();
</script>

<body onLoad="showToolbars();loadLabels()">

<div id="pageHeader">
  <div id="pageHeaderLogo">
    <img src="onion.gif">
  </div>
  <div id="pageHeaderText">
    <a href="http://perldoc.perl.org">perldoc.perl.org</a>
  </div>
</div>

<div id="pageBody">
  <div id="left">
    <div id="leftContent">
      <div id="leftClose">
        <a href="#" onClick="closeLeft()" title="Hide navigation" onmouseover="leftCloseIcon.src='close_purple.gif';" onmouseout="leftCloseIcon.src='close_blue.gif';"><img src="close_blue.gif" name="leftCloseIcon" id="leftCloseIcon" border=0></a>
      </div>
      <h1>Manual:</h1>
      <ul>
        <li><a href="index-overview.html">Overview</a></li>
        <li><a href="index-tutorials.html">Tutorials</a></li>
        <li><a href="index-faq.html">FAQs</a></li>
        <li><a href="index-history.html">History / Changes</a></li>
        <li><a href="index-licence.html">Licence</a></li>
      </ul>
      <h2>Reference:</h2>
      <ul>
        <li><a href="index-language.html">Language</a></li>
        <li><a href="index-functions.html">Functions</a></li>
        <li><a href="perlop.html">Operators</a></li>
        <li><a href="perlvar.html">Special variables</a></li>
        <li><a href="index-pragmas.html">Pragmas</a></li>
        <li><a href="index-modules-A.html">Core modules</a></li>
        <li><a href="index-utilities.html">Utilities</a></li>
        <li><a href="index-internals.html">Internals</a></li>
        <li><a href="index-platforms.html">Platform specific</a></li>
      </ul>
      <h2>Links:</h2>
      <ul>
        <li><a href="http://search.cpan.org">CPAN</a></li>
        <li><a href="http://www.perl.com">Perl.com</a></li>
        <li><a href="http://www.perl.org">Perl.org</a></li>
        <li><a href="http://www.pm.org">Perl Mongers</a></li>
        <li><a href="http://www.perlmonks.org">Perl Monks</a></li>
        <li><a href="http://planet.perl.org">Planet Perl</a></li>
        <li><a href="http://use.perl.org">Use Perl</a></li>
      </ul>
      <h2>Contact:</h2>
      <ul>
        <li>Site maintained by<br><a href="http://perl.jonallen.info">Jon Allen</a>
            (<a href="http://perl.jonallen.info">JJ</a>)</li>
        <li class="spaced">Last updated on<br>23 April 2006</li>
	<li class="spaced">See the <a href="http://perl.jonallen.info/projects/perldoc">project page</a> for
	more details</li>
      </ul>
    </div>
  </div>

  <div id="center">  
    <div id="centerContent">
      <div id="contentHeader">
        <div id="contentHeaderLeft"><a href="#" onClick="showLeft()">Show navigation</a></div>
        <div id="contentHeaderCentre">-- Perl 5.8.8 documentation --</div>
        <div id="contentHeaderRight"><a href="#" onClick="showRight()">Show toolbar</a></div>
      </div>
      <div id="breadCrumbs"><a href="index.html">Home</a> &gt; <a href="index-language.html">Language reference</a> &gt; perlfilter</div>
      <script language="JavaScript">fromSearch();</script>
      <div id="contentBody"><div class="title_container"><div class="page_title">perlfilter</div><div class="pdf_link"><a href="perlfilter.pdf">View as PDF</a></div><div class="pdf_img_link"><a href="perlfilter.pdf"><img src="pdficon.gif" border=0></a></div></div><ul><li><a href="#NAME">NAME</a><li><a href="#DESCRIPTION">DESCRIPTION</a><li><a href="#CONCEPTS">CONCEPTS</a><li><a href="#USING-FILTERS">USING FILTERS</a><li><a href="#WRITING-A-SOURCE-FILTER">WRITING A SOURCE FILTER</a><li><a href="#WRITING-A-SOURCE-FILTER-IN-C">WRITING A SOURCE FILTER IN C</a><li><a href="#CREATING-A-SOURCE-FILTER-AS-A-SEPARATE-EXECUTABLE">CREATING A SOURCE FILTER AS A SEPARATE EXECUTABLE</a><li><a href="#WRITING-A-SOURCE-FILTER-IN-PERL">WRITING A SOURCE FILTER IN PERL</a><li><a href="#USING-CONTEXT%3a-THE-DEBUG-FILTER">USING CONTEXT: THE DEBUG FILTER</a><li><a href="#CONCLUSION">CONCLUSION</a><li><a href="#THINGS-TO-LOOK-OUT-FOR">THINGS TO LOOK OUT FOR</a><li><a href="#REQUIREMENTS">REQUIREMENTS</a><li><a href="#AUTHOR">AUTHOR</a><li><a href="#Copyrights">Copyrights</a></ul><a name="NAME"></a><h1>NAME</h1>
<p>perlfilter - Source Filters</p>
<a name="DESCRIPTION"></a><h1>DESCRIPTION</h1>
<p>This article is about a little-known feature of Perl called
<i>source filters</i>. Source filters alter the program text of a module
before Perl sees it, much as a C preprocessor alters the source text of
a C program before the compiler sees it. This article tells you more
about what source filters are, how they work, and how to write your
own.</p>
<p>The original purpose of source filters was to let you encrypt your
program source to prevent casual piracy. This isn't all they can do, as
you'll soon learn. But first, the basics.</p>
<a name="CONCEPTS"></a><h1>CONCEPTS</h1>
<p>Before the Perl interpreter can execute a Perl script, it must first
read it from a file into memory for parsing and compilation. If that
script itself includes other scripts with a <code class="inline"><a class="l_k" href="functions/use.html">use</a></code> or <code class="inline"><a class="l_k" href="functions/require.html">require</a></code>
statement, then each of those scripts will have to be read from their
respective files as well.</p>
<p>Now think of each logical connection between the Perl parser and an
individual file as a <i>source stream</i>. A source stream is created when
the Perl parser opens a file, it continues to exist as the source code
is read into memory, and it is destroyed when Perl is finished parsing
the file. If the parser encounters a <code class="inline"><a class="l_k" href="functions/require.html">require</a></code> or <code class="inline"><a class="l_k" href="functions/use.html">use</a></code> statement in
a source stream, a new and distinct stream is created just for that
file.</p>
<p>The diagram below represents a single source stream, with the flow of
source from a Perl script file on the left into the Perl parser on the
right. This is how Perl normally operates.</p>
<pre class="verbatim">    file ------<span class="i">-&gt; parser</span></pre>
<p>There are two important points to remember:</p>
<ol>
<li>
<p>Although there can be any number of source streams in existence at any
given time, only one will be active.</p>
</li>
<li>
<p>Every source stream is associated with only one file.</p>
</li>
</ol>
<p>A source filter is a special kind of Perl module that intercepts and
modifies a source stream before it reaches the parser. A source filter
changes our diagram like this:</p>
<pre class="verbatim">    file ----&gt; filter ----&gt; parser</pre>
<p>If that doesn't make much sense, consider the analogy of a command
pipeline. Say you have a shell script stored in the compressed file
<i>trial.gz</i>. The simple pipeline command below runs the script without
needing to create a temporary file to hold the uncompressed file.</p>
<pre class="verbatim">    gunzip -c <span class="i">trial</span>.gz | sh</pre>
<p>In this case, the data flow from the pipeline can be represented as follows:</p>
<pre class="verbatim">    trial.gz ----&gt; gunzip ----&gt; sh</pre>
<p>With source filters, you can store the text of your script compressed and use a source filter to uncompress it for Perl's parser:</p>
<pre class="verbatim">     compressed           gunzip
    Perl program ---&gt; source filter ---&gt; parser</pre><a name="USING-FILTERS"></a><h1>USING FILTERS</h1>
<p>So how do you use a source filter in a Perl script? Above, I said that
a source filter is just a special kind of module. Like all Perl
modules, a source filter is invoked with a use statement.</p>
<p>Say you want to pass your Perl source through the C preprocessor before
execution. You could use the existing <code class="inline">-P</code>
 command line option to do
this, but as it happens, the source filters distribution comes with a C
preprocessor filter module called Filter::cpp. Let's use that instead.</p>
<p>Below is an example program, <code class="inline">cpp_test</code>
, which makes use of this filter.
Line numbers have been added to allow specific lines to be referenced
easily.</p>
<pre class="verbatim">    1: use Filter::cpp;
    2: #define TRUE 1
    3: $a = TRUE;
    4: print "a = $a\n";</pre><p>When you execute this script, Perl creates a source stream for the
file. Before the parser processes any of the lines from the file, the
source stream looks like this:</p>
<pre class="verbatim">    cpp_test --------<span class="i">-&gt; parser</span></pre>
<p>Line 1, <code class="inline"><a class="l_k" href="functions/use.html">use</a> Filter::cpp</code>
, includes and installs the <code class="inline">cpp</code>
 filter
module. All source filters work this way. The use statement is compiled
and executed at compile time, before any more of the file is read, and
it attaches the cpp filter to the source stream behind the scenes. Now
the data flow looks like this:</p>
<pre class="verbatim">    cpp_test ----&gt; cpp filter ----&gt; parser</pre>
<p>As the parser reads the second and subsequent lines from the source
stream, it feeds those lines through the <code class="inline">cpp</code>
 source filter before
processing them. The <code class="inline">cpp</code>
 filter simply passes each line through the
real C preprocessor. The output from the C preprocessor is then
inserted back into the source stream by the filter.</p>
<pre class="verbatim">                  .-&gt; cpp --.
                  |         |
                  |         |
                  |       &lt;-'
   cpp_test ----&gt; cpp filter ----&gt; parser</pre><p>The parser then sees the following code:</p>
<pre class="verbatim">    <a class="l_k" href="functions/use.html">use</a> Filter::cpp<span class="sc">;</span>
    <span class="i">$a</span> = <span class="n">1</span><span class="sc">;</span>
    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;a = $a\n&quot;</span><span class="sc">;</span></pre>
<p>Let's consider what happens when the filtered code includes another
module with use:</p>
<pre class="verbatim">    1: use Filter::cpp;
    2: #define TRUE 1
    3: use Fred;
    4: $a = TRUE;
    5: print "a = $a\n";</pre><p>The <code class="inline">cpp</code>
 filter does not apply to the text of the Fred module, only
to the text of the file that used it (<code class="inline">cpp_test</code>
). Although the use
statement on line 3 will pass through the cpp filter, the module that
gets included (<code class="inline">Fred</code>
) will not. The source streams look like this
after line 3 has been parsed and before line 4 is parsed:</p>
<pre class="verbatim">    cpp_test ---&gt; cpp filter ---&gt; parser (INACTIVE)</pre><pre class="verbatim">    Fred.pm ----&gt; parser</pre>
<p>As you can see, a new stream has been created for reading the source
from <code class="inline">Fred.pm</code>
. This stream will remain active until all of <code class="inline">Fred.pm</code>

has been parsed. The source stream for <code class="inline">cpp_test</code>
 will still exist,
but is inactive. Once the parser has finished reading Fred.pm, the
source stream associated with it will be destroyed. The source stream
for <code class="inline">cpp_test</code>
 then becomes active again and the parser reads line 4
and subsequent lines from <code class="inline">cpp_test</code>
.</p>
<p>You can use more than one source filter on a single file. Similarly,
you can reuse the same filter in as many files as you like.</p>
<p>For example, if you have a uuencoded and compressed source file, it is
possible to stack a uudecode filter and an uncompression filter like
this:</p>
<pre class="verbatim">    use Filter::uudecode; use Filter::uncompress;
    M'XL(".H&lt;US4''V9I;F%L')Q;&gt;7/;1I;_&gt;_I3=&amp;E=%:F*I"T?22Q/
    M6]9*&lt;IQCO*XFT"0[PL%%'Y+IG?WN^ZYN-$'J.[.JE$,20/?K=_[&gt;
    ...</pre><p>Once the first line has been processed, the flow will look like this:</p>
<pre class="verbatim">    file ---&gt; uudecode ---&gt; uncompress ---&gt; parser
               filter         filter</pre><p>Data flows through filters in the same order they appear in the source
file. The uudecode filter appeared before the uncompress filter, so the
source file will be uudecoded before it's uncompressed.</p>
<a name="WRITING-A-SOURCE-FILTER"></a><h1>WRITING A SOURCE FILTER</h1>
<p>There are three ways to write your own source filter. You can write it
in C, use an external program as a filter, or write the filter in Perl.
I won't cover the first two in any great detail, so I'll get them out
of the way first. Writing the filter in Perl is most convenient, so
I'll devote the most space to it.</p>
<a name="WRITING-A-SOURCE-FILTER-IN-C"></a><h1>WRITING A SOURCE FILTER IN C</h1>
<p>The first of the three available techniques is to write the filter
completely in C. The external module you create interfaces directly
with the source filter hooks provided by Perl.</p>
<p>The advantage of this technique is that you have complete control over
the implementation of your filter. The big disadvantage is the
increased complexity required to write the filter - not only do you
need to understand the source filter hooks, but you also need a
reasonable knowledge of Perl guts. One of the few times it is worth
going to this trouble is when writing a source scrambler. The
<code class="inline">decrypt</code>
 filter (which unscrambles the source before Perl parses it)
included with the source filter distribution is an example of a C
source filter (see Decryption Filters, below).</p>
<ul>
<li><a name="*Decryption-Filters*"></a><b><b>Decryption Filters</b></b>
<p>All decryption filters work on the principle of "security through
obscurity." Regardless of how well you write a decryption filter and
how strong your encryption algorithm, anyone determined enough can
retrieve the original source code. The reason is quite simple - once
the decryption filter has decrypted the source back to its original
form, fragments of it will be stored in the computer's memory as Perl
parses it. The source might only be in memory for a short period of
time, but anyone possessing a debugger, skill, and lots of patience can
eventually reconstruct your program.</p>
<p>That said, there are a number of steps that can be taken to make life
difficult for the potential cracker. The most important: Write your
decryption filter in C and statically link the decryption module into
the Perl binary. For further tips to make life difficult for the
potential cracker, see the file <i>decrypt.pm</i> in the source filters
module.</p>
</li>
</ul>
<a name="CREATING-A-SOURCE-FILTER-AS-A-SEPARATE-EXECUTABLE"></a><h1>CREATING A SOURCE FILTER AS A SEPARATE EXECUTABLE</h1>
<p>An alternative to writing the filter in C is to create a separate
executable in the language of your choice. The separate executable
reads from standard input, does whatever processing is necessary, and
writes the filtered data to standard output. <code class="inline"><span class="j">Filter:</span>cpp</code>
 is an
example of a source filter implemented as a separate executable - the
executable is the C preprocessor bundled with your C compiler.</p>
<p>The source filter distribution includes two modules that simplify this
task: <code class="inline">Filter::exec</code>
 and <code class="inline">Filter::sh</code>
. Both allow you to run any
external executable. Both use a coprocess to control the flow of data
into and out of the external executable. (For details on coprocesses,
see Stephens, W.R. "Advanced Programming in the UNIX Environment."
Addison-Wesley, ISBN 0-210-56317-7, pages 441-445.) The difference
between them is that <code class="inline">Filter::exec</code>
 spawns the external command
directly, while <code class="inline">Filter::sh</code>
 spawns a shell to execute the external
command. (Unix uses the Bourne shell; NT uses the cmd shell.) Spawning
a shell allows you to make use of the shell metacharacters and
redirection facilities.</p>
<p>Here is an example script that uses <code class="inline">Filter::sh</code>
:</p>
<pre class="verbatim">    <a class="l_k" href="functions/use.html">use</a> Filter::sh <span class="q">&#39;tr XYZ PQR&#39;</span><span class="sc">;</span>
    <span class="i">$a</span> = <span class="n">1</span><span class="sc">;</span>
    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;XYZ a = $a\n&quot;</span><span class="sc">;</span></pre>
<p>The output you'll get when the script is executed:</p>
<pre class="verbatim">    PQR a = <span class="n">1</span></pre>
<p>Writing a source filter as a separate executable works fine, but a
small performance penalty is incurred. For example, if you execute the
small example above, a separate subprocess will be created to run the
Unix <code class="inline"><a class="l_k" href="functions/tr.html">tr</a></code> command. Each use of the filter requires its own subprocess.
If creating subprocesses is expensive on your system, you might want to
consider one of the other options for creating source filters.</p>
<a name="WRITING-A-SOURCE-FILTER-IN-PERL"></a><h1>WRITING A SOURCE FILTER IN PERL</h1>
<p>The easiest and most portable option available for creating your own
source filter is to write it completely in Perl. To distinguish this
from the previous two techniques, I'll call it a Perl source filter.</p>
<p>To help understand how to write a Perl source filter we need an example
to study. Here is a complete source filter that performs rot13
decoding. (Rot13 is a very simple encryption scheme used in Usenet
postings to hide the contents of offensive posts. It moves every letter
forward thirteen places, so that A becomes N, B becomes O, and Z
becomes M.)</p>
<pre class="verbatim"><a name="package-Rot13"></a>   package <span class="i">Rot13</span><span class="sc">;</span></pre>
<pre class="verbatim">   <a class="l_k" href="functions/use.html">use</a> <a class="l_w" href="Filter/Util/Call.html">Filter::Util::Call</a><span class="sc">;</span></pre>
<pre class="verbatim"><a name="import"></a>   sub <span class="m">import</span> <span class="s">{</span>
      <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$type</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$ref</span><span class="s">)</span> = <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
      <span class="i">filter_add</span><span class="s">(</span><a class="l_k" href="functions/bless.html">bless</a> <span class="i">$ref</span><span class="s">)</span><span class="sc">;</span>
   <span class="s">}</span></pre>
<pre class="verbatim">   sub filter {
      my ($self) = @_;
      my ($status);</pre><pre class="verbatim">      tr/n-za-mN-ZA-M/a-zA-Z/
         if ($status = filter_read()) &gt; 0;
      $status;
   }</pre><pre class="verbatim">   <span class="n">1</span><span class="sc">;</span></pre>
<p>All Perl source filters are implemented as Perl classes and have the
same basic structure as the example above.</p>
<p>First, we include the <code class="inline"><a class="l_w" href="Filter/Util/Call.html">Filter::Util::Call</a></code> module, which exports a
number of functions into your filter's namespace. The filter shown
above uses two of these functions, <code class="inline"><span class="i">filter_add</span><span class="s">(</span><span class="s">)</span></code>
 and
<code class="inline"><span class="i">filter_read</span><span class="s">(</span><span class="s">)</span></code>
.</p>
<p>Next, we create the filter object and associate it with the source
stream by defining the <code class="inline"><a class="l_k" href="functions/import.html">import</a></code> function. If you know Perl well
enough, you know that <code class="inline"><a class="l_k" href="functions/import.html">import</a></code> is called automatically every time a
module is included with a use statement. This makes <code class="inline"><a class="l_k" href="functions/import.html">import</a></code> the ideal
place to both create and install a filter object.</p>
<p>In the example filter, the object (<code class="inline"><span class="i">$ref</span></code>
) is blessed just like any
other Perl object. Our example uses an anonymous array, but this isn't
a requirement. Because this example doesn't need to store any context
information, we could have used a scalar or hash reference just as
well. The next section demonstrates context data.</p>
<p>The association between the filter object and the source stream is made
with the <code class="inline"><span class="i">filter_add</span><span class="s">(</span><span class="s">)</span></code>
 function. This takes a filter object as a
parameter (<code class="inline"><span class="i">$ref</span></code>
 in this case) and installs it in the source stream.</p>
<p>Finally, there is the code that actually does the filtering. For this
type of Perl source filter, all the filtering is done in a method
called <code class="inline"><span class="i">filter</span><span class="s">(</span><span class="s">)</span></code>
. (It is also possible to write a Perl source filter
using a closure. See the <code class="inline"><a class="l_w" href="Filter/Util/Call.html">Filter::Util::Call</a></code> manual page for more
details.) It's called every time the Perl parser needs another line of
source to process. The <code class="inline"><span class="i">filter</span><span class="s">(</span><span class="s">)</span></code>
 method, in turn, reads lines from
the source stream using the <code class="inline"><span class="i">filter_read</span><span class="s">(</span><span class="s">)</span></code>
 function.</p>
<p>If a line was available from the source stream, <code class="inline"><span class="i">filter_read</span><span class="s">(</span><span class="s">)</span></code>

returns a status value greater than zero and appends the line to <code class="inline"><span class="i">$_</span></code>
.
A status value of zero indicates end-of-file, less than zero means an
error. The filter function itself is expected to return its status in
the same way, and put the filtered line it wants written to the source
stream in <code class="inline"><span class="i">$_</span></code>
. The use of <code class="inline"><span class="i">$_</span></code>
 accounts for the brevity of most Perl
source filters.</p>
<p>In order to make use of the rot13 filter we need some way of encoding
the source file in rot13 format. The script below, <code class="inline">mkrot13</code>
, does
just that.</p>
<pre class="verbatim">    <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;usage mkrot13 filename\n&quot;</span> unless <span class="i">@ARGV</span><span class="sc">;</span>
    <a class="l_k" href="functions/my.html">my</a> <span class="i">$in</span> = <span class="i">$ARGV</span>[<span class="n">0</span>]<span class="sc">;</span>
    <a class="l_k" href="functions/my.html">my</a> <span class="i">$out</span> = <span class="q">&quot;$in.tmp&quot;</span><span class="sc">;</span>
    <a class="l_k" href="functions/open.html">open</a><span class="s">(</span>IN<span class="cm">,</span> <span class="q">&quot;&lt;$in&quot;</span><span class="s">)</span> or <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;Cannot open file $in: $!\n&quot;</span><span class="sc">;</span>
    <a class="l_k" href="functions/open.html">open</a><span class="s">(</span>OUT<span class="cm">,</span> <span class="q">&quot;&gt;$out&quot;</span><span class="s">)</span> or <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;Cannot open file $out: $!\n&quot;</span><span class="sc">;</span></pre>
<pre class="verbatim">    <a class="l_k" href="functions/print.html">print</a> <span class="i">OUT</span> <span class="q">&quot;use Rot13;\n&quot;</span><span class="sc">;</span>
    while <span class="s">(</span><span class="q">&lt;IN&gt;</span><span class="s">)</span> <span class="s">{</span>
       <span class="q">tr/a-zA-Z/n-za-mN-ZA-M/</span><span class="sc">;</span>
       <a class="l_k" href="functions/print.html">print</a> <span class="i">OUT</span><span class="sc">;</span>
    <span class="s">}</span></pre>
<pre class="verbatim">    <a class="l_k" href="functions/close.html">close</a> IN<span class="sc">;</span>
    <a class="l_k" href="functions/close.html">close</a> OUT<span class="sc">;</span>
    <a class="l_k" href="functions/unlink.html">unlink</a> <span class="i">$in</span><span class="sc">;</span>
    <a class="l_k" href="functions/rename.html">rename</a> <span class="i">$out</span><span class="cm">,</span> <span class="i">$in</span><span class="sc">;</span></pre>
<p>If we encrypt this with <code class="inline">mkrot13</code>
:</p>
<pre class="verbatim">    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot; hello fred \n&quot;</span><span class="sc">;</span></pre>
<p>the result will be this:</p>
<pre class="verbatim">    <a class="l_k" href="functions/use.html">use</a> Rot13<span class="sc">;</span>
    cevag <span class="q">&quot;uryyb serq\a&quot;</span><span class="sc">;</span></pre>
<p>Running it produces this output:</p>
<pre class="verbatim">    hello fred</pre>
<a name="USING-CONTEXT%3a-THE-DEBUG-FILTER"></a><h1>USING CONTEXT: THE DEBUG FILTER</h1>
<p>The rot13 example was a trivial example. Here's another demonstration
that shows off a few more features.</p>
<p>Say you wanted to include a lot of debugging code in your Perl script
during development, but you didn't want it available in the released
product. Source filters offer a solution. In order to keep the example
simple, let's say you wanted the debugging output to be controlled by
an environment variable, <code class="inline">DEBUG</code>
. Debugging code is enabled if the
variable exists, otherwise it is disabled.</p>
<p>Two special marker lines will bracket debugging code, like this:</p>
<pre class="verbatim">    <span class="c">## DEBUG_BEGIN</span>
    if <span class="s">(</span><span class="i">$year</span> &gt; <span class="n">1999</span><span class="s">)</span> <span class="s">{</span>
       <a class="l_k" href="functions/warn.html">warn</a> <span class="q">&quot;Debug: millennium bug in year $year\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">## DEBUG_END</span></pre>
<p>When the <code class="inline">DEBUG</code>
 environment variable exists, the filter ensures that
Perl parses only the code between the <code class="inline">DEBUG_BEGIN</code>
 and <code class="inline">DEBUG_END</code>

markers. That means that when <code class="inline">DEBUG</code>
 does exist, the code above
should be passed through the filter unchanged. The marker lines can
also be passed through as-is, because the Perl parser will see them as
comment lines. When <code class="inline">DEBUG</code>
 isn't set, we need a way to disable the
debug code. A simple way to achieve that is to convert the lines
between the two markers into comments:</p>
<pre class="verbatim">    <span class="c">## DEBUG_BEGIN</span>
    <span class="c">#if ($year &gt; 1999) {</span>
    <span class="c">#     warn &quot;Debug: millennium bug in year $year\n&quot;;</span>
    <span class="c">#}</span>
    <span class="c">## DEBUG_END</span></pre>
<p>Here is the complete Debug filter:</p>
<pre class="verbatim"><a name="package-Debug"></a>    package <span class="i">Debug</span><span class="sc">;</span></pre>
<pre class="verbatim">    <a class="l_k" href="functions/use.html">use</a> <a class="l_w" href="strict.html">strict</a><span class="sc">;</span>
    <a class="l_k" href="functions/use.html">use</a> <a class="l_w" href="warnings.html">warnings</a><span class="sc">;</span>
    <a class="l_k" href="functions/use.html">use</a> <a class="l_w" href="Filter/Util/Call.html">Filter::Util::Call</a><span class="sc">;</span></pre>
<pre class="verbatim">    <a class="l_k" href="functions/use.html">use</a> <a class="l_w" href="constant.html">constant</a> <span class="i">TRUE</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="sc">;</span>
    <a class="l_k" href="functions/use.html">use</a> <a class="l_w" href="constant.html">constant</a> <span class="i">FALSE</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="sc">;</span></pre>
<pre class="verbatim"><a name="import"></a>    sub <span class="m">import</span> <span class="s">{</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$type</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">%context</span><span class="s">)</span> = <span class="s">(</span>
         Enabled <span class="cm">=&gt;</span> <a class="l_k" href="functions/defined.html">defined</a> <span class="i">$ENV</span>{DEBUG}<span class="cm">,</span>
         InTraceBlock <span class="cm">=&gt;</span> FALSE<span class="cm">,</span>
         Filename <span class="cm">=&gt;</span> <span class="s">(</span><a class="l_k" href="functions/caller.html">caller</a><span class="s">)</span>[<span class="n">1</span>]<span class="cm">,</span>
         LineNo <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
         LastBegin <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
       <span class="s">)</span><span class="sc">;</span>
       <span class="i">filter_add</span><span class="s">(</span><a class="l_k" href="functions/bless.html">bless</a> \<span class="i">%context</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span></pre>
<pre class="verbatim"><a name="Die"></a>    sub <span class="m">Die</span> <span class="s">{</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$self</span><span class="s">)</span> = <a class="l_k" href="functions/shift.html">shift</a><span class="sc">;</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$message</span><span class="s">)</span> = <a class="l_k" href="functions/shift.html">shift</a><span class="sc">;</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$line_no</span><span class="s">)</span> = <a class="l_k" href="functions/shift.html">shift</a> || <span class="i">$self</span>-&gt;{LastBegin}<span class="sc">;</span>
       <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;$message at $self-&gt;{Filename} line $line_no.\n&quot;</span>
    <span class="s">}</span></pre>
<pre class="verbatim">    sub filter {
       my ($self) = @_;
       my ($status);
       $status = filter_read();
       ++ $self-&gt;{LineNo};</pre><pre class="verbatim">       <span class="c"># deal with EOF/error first</span>
       if <span class="s">(</span><span class="i">$status</span> &lt;= <span class="n">0</span><span class="s">)</span> <span class="s">{</span>
           <span class="i">$self</span><span class="i">-&gt;Die</span><span class="s">(</span><span class="q">&quot;DEBUG_BEGIN has no DEBUG_END&quot;</span><span class="s">)</span>
               if <span class="i">$self</span>-&gt;{InTraceBlock}<span class="sc">;</span>
           <a class="l_k" href="functions/return.html">return</a> <span class="i">$status</span><span class="sc">;</span>
       <span class="s">}</span></pre>
<pre class="verbatim">       if ($self-&gt;{InTraceBlock}) {
          if (/^\s*##\s*DEBUG_BEGIN/ ) {
              $self-&gt;Die("Nested DEBUG_BEGIN", $self-&gt;{LineNo})
          } elsif (/^\s*##\s*DEBUG_END/) {
              $self-&gt;{InTraceBlock} = FALSE;
          }</pre><pre class="verbatim">          # comment out the debug lines when the filter is disabled
          s/^/#/ if ! $self-&gt;{Enabled};
       } elsif ( /^\s*##\s*DEBUG_BEGIN/ ) {
          $self-&gt;{InTraceBlock} = TRUE;
          $self-&gt;{LastBegin} = $self-&gt;{LineNo};
       } elsif ( /^\s*##\s*DEBUG_END/ ) {
          $self-&gt;Die("DEBUG_END has no DEBUG_BEGIN", $self-&gt;{LineNo});
       }
       return $status;
    }</pre><pre class="verbatim">    <span class="n">1</span><span class="sc">;</span></pre>
<p>The big difference between this filter and the previous example is the
use of context data in the filter object. The filter object is based on
a hash reference, and is used to keep various pieces of context
information between calls to the filter function. All but two of the
hash fields are used for error reporting. The first of those two,
Enabled, is used by the filter to determine whether the debugging code
should be given to the Perl parser. The second, InTraceBlock, is true
when the filter has encountered a <code class="inline">DEBUG_BEGIN</code>
 line, but has not yet
encountered the following <code class="inline">DEBUG_END</code>
 line.</p>
<p>If you ignore all the error checking that most of the code does, the
essence of the filter is as follows:</p>
<pre class="verbatim">    sub filter {
       my ($self) = @_;
       my ($status);
       $status = filter_read();</pre><pre class="verbatim">       # deal with EOF/error first
       return $status if $status &lt;= 0;
       if ($self-&gt;{InTraceBlock}) {
          if (/^\s*##\s*DEBUG_END/) {
             $self-&gt;{InTraceBlock} = FALSE
          }</pre><pre class="verbatim">          # comment out debug lines when the filter is disabled
          s/^/#/ if ! $self-&gt;{Enabled};
       } elsif ( /^\s*##\s*DEBUG_BEGIN/ ) {
          $self-&gt;{InTraceBlock} = TRUE;
       }
       return $status;
    }</pre><p>Be warned: just as the C-preprocessor doesn't know C, the Debug filter
doesn't know Perl. It can be fooled quite easily:</p>
<pre class="verbatim">    print &lt;&lt;EOM;
    ##DEBUG_BEGIN
    EOM</pre><p>Such things aside, you can see that a lot can be achieved with a modest
amount of code.</p>
<a name="CONCLUSION"></a><h1>CONCLUSION</h1>
<p>You now have better understanding of what a source filter is, and you
might even have a possible use for them. If you feel like playing with
source filters but need a bit of inspiration, here are some extra
features you could add to the Debug filter.</p>
<p>First, an easy one. Rather than having debugging code that is
all-or-nothing, it would be much more useful to be able to control
which specific blocks of debugging code get included. Try extending the
syntax for debug blocks to allow each to be identified. The contents of
the <code class="inline">DEBUG</code>
 environment variable can then be used to control which
blocks get included.</p>
<p>Once you can identify individual blocks, try allowing them to be
nested. That isn't difficult either.</p>
<p>Here is an interesting idea that doesn't involve the Debug filter.
Currently Perl subroutines have fairly limited support for formal
parameter lists. You can specify the number of parameters and their
type, but you still have to manually take them out of the <code class="inline"><span class="i">@_</span></code>
 array
yourself. Write a source filter that allows you to have a named
parameter list. Such a filter would turn this:</p>
<pre class="verbatim"><a name="MySub"></a>    sub <span class="m">MySub ($first, $second, @rest)</span> <span class="s">{</span> ... <span class="s">}</span></pre>
<p>into this:</p>
<pre class="verbatim"><a name="MySub"></a>    sub <span class="m">MySub($$@)</span> <span class="s">{</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$first</span><span class="s">)</span> = <a class="l_k" href="functions/shift.html">shift</a><span class="sc">;</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$second</span><span class="s">)</span> = <a class="l_k" href="functions/shift.html">shift</a><span class="sc">;</span>
       <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">@rest</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
       ...
    <span class="s">}</span></pre>
<p>Finally, if you feel like a real challenge, have a go at writing a
full-blown Perl macro preprocessor as a source filter. Borrow the
useful features from the C preprocessor and any other macro processors
you know. The tricky bit will be choosing how much knowledge of Perl's
syntax you want your filter to have.</p>
<a name="THINGS-TO-LOOK-OUT-FOR"></a><h1>THINGS TO LOOK OUT FOR</h1>
<ul>
<li><a name="Some-Filters-Clobber-the-'DATA'-Handle"></a><b>Some Filters Clobber the <code class="inline">DATA</code>
 Handle</b>
<p>Some source filters use the <code class="inline">DATA</code>
 handle to read the calling program.
When using these source filters you cannot rely on this handle, nor expect
any particular kind of behavior when operating on it.  Filters based on
Filter::Util::Call (and therefore Filter::Simple) do not alter the <code class="inline">DATA</code>

filehandle.</p>
</li>
</ul>
<a name="REQUIREMENTS"></a><h1>REQUIREMENTS</h1>
<p>The Source Filters distribution is available on CPAN, in </p>
<pre class="verbatim">    <a class="l_w" href="CPAN.html">CPAN</a>/modules/by-module/Filter</pre>
<p>Starting from Perl 5.8 Filter::Util::Call (the core part of the
Source Filters distribution) is part of the standard Perl distribution.
Also included is a friendlier interface called Filter::Simple, by
Damian Conway.</p>
<a name="AUTHOR"></a><h1>AUTHOR</h1>
<p>Paul Marquess &lt;Paul.Marquess@btinternet.com&gt;</p>
<a name="Copyrights"></a><h1>Copyrights</h1>
<p>This article originally appeared in The Perl Journal #11, and is
copyright 1998 The Perl Journal. It appears courtesy of Jon Orwant and
The Perl Journal.  This document may be distributed under the same terms
as Perl itself.</p>
</div>
      <div id="contentFooter"><a href="http://www.perl.org"><img src="perlpowered.png" border=0></a></div>
    </div>
  </div>

  <div id="right">
    <div id="rightContent">
      <div id="leftClose">
        <a href="#" onClick="closeRight()" title="Hide toolbar" onmouseover="rightCloseIcon.src='close_purple.gif';" onmouseout="rightCloseIcon.src='close_blue.gif';"><img src="close_blue.gif" name="rightCloseIcon" id="rightCloseIcon" border=0></a>
      </div>
      <h1>Search:</h1>
      <p>
        <form action="search.html" name="perldoc_search">
	  <input type="text" name="q" size="10" class="grey"><br>
	  <!--<select name="r"><option value="1" selected>Go to top result<option value="0">Show results list</select>-->
	</form>
      </p>
      <h2>Labels:</h2>
      <p>
        <a href="#" onClick="addLabel('perlfilter','perlfilter.html')">Add this page</a>
      </p>
      <div class="labels" id="labels">
      </div>
    </div>
  </div>

</div>

</body>
</html>
